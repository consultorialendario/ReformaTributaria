<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculadora Inteligente de Impostos - Brasil</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #2c3e50, #3498db);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .progress-bar {
            background: rgba(255,255,255,0.2);
            height: 8px;
            border-radius: 4px;
            margin-top: 20px;
            overflow: hidden;
        }

        .progress-fill {
            background: #27ae60;
            height: 100%;
            width: 25%;
            transition: width 0.3s ease;
            border-radius: 4px;
        }
        
        .main-content {
            padding: 30px;
        }

        .wizard-steps {
            display: flex;
            justify-content: center;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .step {
            display: flex;
            align-items: center;
            padding: 10px 20px;
            margin: 5px;
            border-radius: 25px;
            font-weight: 600;
            transition: all 0.3s;
        }

        .step.active {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            transform: scale(1.05);
        }

        .step.completed {
            background: linear-gradient(135deg, #27ae60, #229954);
            color: white;
        }

        .step.pending {
            background: #f8f9fa;
            color: #6c757d;
            border: 2px solid #e9ecef;
        }
        
        .section {
            background: #ffffff;
            border: 2px solid #e3e6f0;
            border-radius: 12px;
            margin-bottom: 25px;
            overflow: hidden;
            display: none;
        }

        .section.active {
            display: block;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .section-header {
            padding: 20px;
            font-weight: bold;
            font-size: 1.3em;
            color: white;
            text-align: center;
        }
        
        .config-header { background: linear-gradient(135deg, #9b59b6, #8e44ad); }
        .receitas-header { background: linear-gradient(135deg, #27ae60, #229954); }
        .custos-header { background: linear-gradient(135deg, #e74c3c, #c0392b); }
        .resultados-header { background: linear-gradient(135deg, #f39c12, #e67e22); }
        
        .section-content {
            padding: 25px;
        }
        
        .input-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .input-field {
            display: flex;
            flex-direction: column;
        }
        
        .input-field label {
            font-weight: 600;
            margin-bottom: 8px;
            color: #2c3e50;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .input-field input, .input-field select {
            padding: 12px;
            border: 2px solid #e3e6f0;
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.3s;
        }
        
        .input-field input:focus, .input-field select:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }

        .receita-group {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            border-left: 5px solid #27ae60;
        }

        .custo-group {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            border-left: 5px solid #e74c3c;
        }

        .group-title {
            font-weight: bold;
            font-size: 1.1em;
            margin-bottom: 15px;
            color: #2c3e50;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .auto-calc {
            background: #e8f5e8;
            border: 2px solid #27ae60;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
        }

        .auto-calc .label {
            font-weight: 600;
            color: #27ae60;
            margin-bottom: 5px;
        }

        .auto-calc .value {
            font-size: 1.2em;
            font-weight: bold;
            color: #2c3e50;
        }

        .imposto-card {
            background: white;
            border: 2px solid #e3e6f0;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .imposto-card.devedor {
            border-left: 5px solid #e74c3c;
            background: linear-gradient(135deg, rgba(231, 76, 60, 0.1), rgba(192, 57, 43, 0.05));
        }

        .imposto-card.credor {
            border-left: 5px solid #27ae60;
            background: linear-gradient(135deg, rgba(39, 174, 96, 0.1), rgba(34, 153, 84, 0.05));
        }

        .imposto-card.neutro {
            border-left: 5px solid #95a5a6;
            background: linear-gradient(135deg, rgba(149, 165, 166, 0.1), rgba(127, 140, 141, 0.05));
        }

        .imposto-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .imposto-nome {
            font-size: 1.2em;
            font-weight: bold;
            color: #2c3e50;
        }

        .imposto-valor {
            font-size: 1.4em;
            font-weight: bold;
        }

        .imposto-valor.devedor { color: #e74c3c; }
        .imposto-valor.credor { color: #27ae60; }
        .imposto-valor.neutro { color: #95a5a6; }

        .calculo-detalhes {
            font-size: 0.9em;
            color: #6c757d;
            line-height: 1.4;
        }

        .btn {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin: 5px;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.3);
        }

        .btn-primary { background: linear-gradient(135deg, #3498db, #2980b9); }
        .btn-success { background: linear-gradient(135deg, #27ae60, #229954); }
        .btn-warning { background: linear-gradient(135deg, #f39c12, #e67e22); }
        .btn-secondary { background: linear-gradient(135deg, #95a5a6, #7f8c8d); }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .navigation {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 2px solid #e9ecef;
        }

        .summary-total {
            background: linear-gradient(135deg, #2c3e50, #3498db);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            margin-top: 20px;
        }

        .summary-total h3 {
            margin-bottom: 10px;
        }

        .summary-total .valor {
            font-size: 2.2em;
            font-weight: bold;
        }

        .alert {
            padding: 15px;
            margin: 15px 0;
            border-radius: 8px;
            font-weight: 500;
        }

        .alert-info {
            background: #d1ecf1;
            border: 1px solid #bee5eb;
            color: #0c5460;
        }

        .alert-warning {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
        }

        .alert-success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }

        @media (max-width: 768px) {
            .container {
                margin: 10px;
            }
            
            .main-content {
                padding: 20px;
            }
            
            .input-group {
                grid-template-columns: 1fr;
            }

            .wizard-steps {
                flex-direction: column;
                align-items: center;
            }

            .navigation {
                flex-direction: column;
                gap: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🧠 Calculadora Inteligente de Impostos</h1>
            <p>Sistema Unificado - Digite Uma Vez, Calcule Todos os Impostos</p>
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
        </div>
        
        <div class="main-content">
            <!-- Wizard Steps -->
            <div class="wizard-steps">
                <div class="step active" id="step1">
                    <span>1️⃣ Configuração</span>
                </div>
                <div class="step pending" id="step2">
                    <span>2️⃣ Receitas</span>
                </div>
                <div class="step pending" id="step3">
                    <span>3️⃣ Custos</span>
                </div>
                <div class="step pending" id="step4">
                    <span>4️⃣ Resultados</span>
                </div>
            </div>

            <!-- SEÇÃO 1: CONFIGURAÇÃO -->
            <div class="section active" id="secao1">
                <div class="section-header config-header">
                    ⚙️ Configuração da Empresa e Regime Tributário
                </div>
                <div class="section-content">
                    <div class="input-group">
                        <div class="input-field">
                            <label>📅 Período de Apuração:</label>
                            <input type="month" id="periodo" value="2025-06">
                        </div>
                        <div class="input-field">
                            <label>🏢 Regime Tributário:</label>
                            <select id="regime" onchange="atualizarRegime()">
                                <option value="lucro_real">Lucro Real</option>
                                <option value="lucro_presumido">Lucro Presumido</option>
                                <option value="simples">Simples Nacional</option>
                            </select>
                        </div>
                        <div class="input-field">
                            <label>🌍 Estado Principal:</label>
                            <select id="estado">
                                <option value="SP">São Paulo</option>
                                <option value="RJ">Rio de Janeiro</option>
                                <option value="MG">Minas Gerais</option>
                                <option value="RS">Rio Grande do Sul</option>
                                <option value="PR">Paraná</option>
                                <option value="SC">Santa Catarina</option>
                            </select>
                        </div>
                        <div class="input-field">
                            <label>🎯 Atividade Principal:</label>
                            <select id="atividade" onchange="atualizarAtividade()">
                                <option value="comercio">Comércio</option>
                                <option value="industria">Indústria</option>
                                <option value="servicos">Serviços</option>
                                <option value="misto">Atividade Mista</option>
                            </select>
                        </div>
                    </div>

                    <div id="infoRegime" class="alert alert-info">
                        <strong>🎯 Regime Selecionado:</strong> <span id="regimeInfo">Lucro Real - Permite créditos de PIS/COFINS não cumulativo</span>
                    </div>
                </div>
            </div>

            <!-- SEÇÃO 2: RECEITAS -->
            <div class="section" id="secao2">
                <div class="section-header receitas-header">
                    💰 Receitas do Período - Base Única para Todos os Impostos
                </div>
                <div class="section-content">
                    
                    <div class="receita-group">
                        <div class="group-title">
                            🛍️ Vendas de Produtos (Base ICMS + PIS/COFINS)
                        </div>
                        <div class="input-group">
                            <div class="input-field">
                                <label>💼 Vendas Internas (dentro do estado):</label>
                                <input type="number" id="vendasInternas" placeholder="0,00" oninput="calcularAutomatico()">
                            </div>
                            <div class="input-field">
                                <label>📊 Alíquota ICMS Interna (%):</label>
                                <input type="number" id="aliquotaICMSInterna" value="18" min="7" max="25" step="0.01" placeholder="18%" oninput="validarAliquotaICMS(); calcularAutomatico()">
                                <small style="color: #6c757d; margin-top: 5px;">⚠️ Varia por estado (7% a 25%)</small>
                            </div>
                            <div class="input-field">
                                <label>📦 Vendas Interestaduais:</label>
                                <input type="number" id="vendasInterestaduais" placeholder="0,00" oninput="calcularAutomatico()">
                            </div>
                            <div class="input-field">
                                <label>📊 Alíquota ICMS Interestadual (%):</label>
                                <input type="number" id="aliquotaICMSInter" value="12" min="4" max="12" step="0.01" placeholder="12%" oninput="validarAliquotaICMSInter(); calcularAutomatico()">
                                <small style="color: #6c757d; margin-top: 5px;">⚠️ Geralmente 4%, 7% ou 12%</small>
                            </div>
                            <div class="input-field">
                                <label>🌍 Exportações (sem impostos):</label>
                                <input type="number" id="exportacoes" placeholder="0,00" oninput="calcularAutomatico()">
                            </div>
                            <div class="input-field">
                                <label>🏭 Vendas Industrializadas (c/ IPI):</label>
                                <input type="number" id="vendasIPI" placeholder="0,00" oninput="calcularAutomatico()">
                                <small style="color: #6c757d; margin-top: 5px;">💡 Apenas produtos industrializados</small>
                            </div>
                            <div class="input-field">
                                <label>📊 Alíquota IPI (%):</label>
                                <input type="number" id="aliquotaIPI" value="10" min="0" max="300" step="0.01" placeholder="10%" oninput="calcularAutomatico()">
                                <small style="color: #6c757d; margin-top: 5px;">⚠️ Consulte TIPI (0% a 300%+)</small>
                            </div>
                        </div>
                        
                        <div class="auto-calc">
                            <div class="label">📊 Total Vendas de Produtos:</div>
                            <div class="value" id="totalProdutos">R$ 0,00</div>
                        </div>
                        
                        <div class="alert alert-info" style="margin-top: 15px;">
                            <strong>ℹ️ Alíquotas ICMS por Estado:</strong><br>
                            • <strong>Internas:</strong> Variam de 7% a 25% conforme produto e estado<br>
                            • <strong>Interestaduais:</strong> 4% (Norte/Nordeste/Centro-Oeste), 7% ou 12% (Sul/Sudeste)<br>
                            • Consulte a SEFAZ do seu estado para alíquotas específicas<br><br>
                            
                            <strong>🏭 Alíquotas IPI (TIPI):</strong><br>
                            • Variam de 0% a 300%+ conforme NCM do produto<br>
                            • Consulte a Tabela TIPI no site da Receita Federal<br>
                            • Produtos essenciais: geralmente 0% ou alíquotas baixas<br>
                            • Produtos supérfluos: alíquotas mais altas
                        </div>
                    </div>

                    <div class="receita-group">
                        <div class="group-title">
                            🏢 Prestação de Serviços (Base ISS + PIS/COFINS)
                        </div>
                        <div class="input-group">
                            <div class="input-field">
                                <label>🏪 Serviços no Município:</label>
                                <input type="number" id="servicosMunicipio" placeholder="0,00" oninput="calcularAutomatico()">
                            </div>
                            <div class="input-field">
                                <label>📊 Alíquota ISS do Município (%):</label>
                                <input type="number" id="aliquotaISS" value="5" min="2" max="5" step="0.01" placeholder="5,00%" oninput="validarAliquotaISS(); calcularAutomatico()">
                                <small style="color: #6c757d; margin-top: 5px;">⚠️ Consulte a legislação do seu município (2% a 5%)</small>
                            </div>
                            <div class="input-field">
                                <label>🌐 Serviços Outros Municípios:</label>
                                <input type="number" id="servicosOutros" placeholder="0,00" oninput="calcularAutomatico()">
                            </div>
                            <div class="input-field">
                                <label>🌎 Serviços no Exterior:</label>
                                <input type="number" id="servicosExterior" placeholder="0,00" oninput="calcularAutomatico()">
                            </div>
                        </div>
                        
                        <div class="alert alert-warning" style="margin-top: 15px;">
                            <strong>⚠️ IMPORTANTE - Alíquota do ISS:</strong><br>
                            • A alíquota varia por município (2% a 5%)<br>
                            • Alguns serviços têm alíquotas específicas<br>
                            • Consulte sempre a legislação municipal atual<br><br>
                            
                            <strong>📍 Principais Capitais (Alíquotas Gerais):</strong><br>
                            • <strong>São Paulo/SP:</strong> 2% a 5% (por tipo de serviço)<br>
                            • <strong>Rio de Janeiro/RJ:</strong> 2% a 5% (por atividade)<br>
                            • <strong>Brasília/DF:</strong> 2% a 5% (conforme lista)<br>
                            • <strong>Belo Horizonte/MG:</strong> 2% a 5%<br>
                            • <strong>Salvador/BA:</strong> 2% a 5%<br>
                            • <strong>Curitiba/PR:</strong> 2,9% a 5%<br><br>
                            
                            <strong>🔍 Onde Consultar:</strong><br>
                            • Site da Prefeitura Municipal<br>
                            • Código Tributário Municipal<br>
                            • Contador da empresa<br>
                            • Secretaria de Fazenda Municipal
                        </div>
                        
                        <div class="auto-calc">
                            <div class="label">📊 Total Prestação de Serviços:</div>
                            <div class="value" id="totalServicos">R$ 0,00</div>
                        </div>
                    </div>

                    <div class="receita-group">
                        <div class="group-title">
                            💸 Outras Receitas
                        </div>
                        <div class="input-group">
                            <div class="input-field">
                                <label>💰 Receitas Financeiras:</label>
                                <input type="number" id="receitasFinanceiras" placeholder="0,00" oninput="calcularAutomatico()">
                            </div>
                            <div class="input-field">
                                <label>📈 Outras Receitas Operacionais:</label>
                                <input type="number" id="outrasReceitas" placeholder="0,00" oninput="calcularAutomatico()">
                            </div>
                        </div>
                    </div>

                    <div class="summary-total">
                        <h3>💯 FATURAMENTO TOTAL DO PERÍODO</h3>
                        <div class="valor" id="faturamentoTotal">R$ 0,00</div>
                        <p style="margin-top: 10px; opacity: 0.9;">
                            Base automática para PIS/COFINS = <span id="basePisCofins">R$ 0,00</span>
                        </p>
                    </div>
                </div>
            </div>

            <!-- SEÇÃO 3: CUSTOS -->
            <div class="section" id="secao3">
                <div class="section-header custos-header">
                    📋 Custos e Despesas - Base Única para Créditos
                </div>
                <div class="section-content">
                    
                    <div class="custo-group">
                        <div class="group-title">
                            🔄 Créditos de ICMS/IPI/PIS/COFINS
                        </div>
                        <div class="input-group">
                            <div class="input-field">
                                <label>🛒 Aquisições de Mercadorias para Revenda:</label>
                                <input type="number" id="aquisicoesRevenda" placeholder="0,00" oninput="calcularAutomatico()">
                            </div>
                            <div class="input-field">
                                <label>🏭 Matérias-primas e Insumos de Produção:</label>
                                <input type="number" id="materiasPrimas" placeholder="0,00" oninput="calcularAutomatico()">
                            </div>
                            <div class="input-field">
                                <label>⚡ Energia Elétrica:</label>
                                <input type="number" id="energiaEletrica" placeholder="0,00" oninput="calcularAutomatico()">
                            </div>
                            <div class="input-field">
                                <label>📞 Telecomunicações:</label>
                                <input type="number" id="telecomunicacoes" placeholder="0,00" oninput="calcularAutomatico()">
                            </div>
                            <div class="input-field">
                                <label>🏠 Aluguéis de Imóveis e Equipamentos:</label>
                                <input type="number" id="alugueis" placeholder="0,00" oninput="calcularAutomatico()">
                            </div>
                            <div class="input-field">
                                <label>🏗️ Aquisições de Ativo Imobilizado:</label>
                                <input type="number" id="ativoImobilizado" placeholder="0,00" oninput="calcularAutomatico()">
                            </div>
                        </div>
                    </div>

                    <div class="custo-group">
                        <div class="group-title">
                            💾 Saldos Credores de Períodos Anteriores
                        </div>
                        <div class="input-group">
                            <div class="input-field">
                                <label>ICMS Saldo Credor Anterior:</label>
                                <input type="number" id="saldoICMS" placeholder="0,00" oninput="calcularAutomatico()">
                            </div>
                            <div class="input-field">
                                <label>IPI Saldo Credor Anterior:</label>
                                <input type="number" id="saldoIPI" placeholder="0,00" oninput="calcularAutomatico()">
                            </div>
                            <div class="input-field">
                                <label>PIS Saldo Credor Anterior:</label>
                                <input type="number" id="saldoPIS" placeholder="0,00" oninput="calcularAutomatico()">
                            </div>
                            <div class="input-field">
                                <label>COFINS Saldo Credor Anterior:</label>
                                <input type="number" id="saldoCOFINS" placeholder="0,00" oninput="calcularAutomatico()">
                            </div>
                        </div>
                    </div>

                    <div class="custo-group">
                        <div class="group-title">
                            📑 Deduções Específicas
                        </div>
                        <div class="input-group">
                            <div class="input-field">
                                <label>ISS Retido na Fonte:</label>
                                <input type="number" id="issRetido" placeholder="0,00" oninput="calcularAutomatico()">
                            </div>
                            <div class="input-field">
                                <label>Deduções Permitidas no ISS:</label>
                                <input type="number" id="deducoesISS" placeholder="0,00" oninput="calcularAutomatico()">
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- SEÇÃO 4: RESULTADOS -->
            <div class="section" id="secao4">
                <div class="section-header resultados-header">
                    📊 Apuração Automática - Todos os Impostos
                </div>
                <div class="section-content">
                    
                    <div id="resultadosImpostos">
                        <!-- Os cards dos impostos serão inseridos aqui via JavaScript -->
                    </div>

                    <div class="summary-total">
                        <h3>💰 TOTAL GERAL A RECOLHER</h3>
                        <div class="valor" id="totalRecolher">R$ 0,00</div>
                        <p style="margin-top: 10px; opacity: 0.9;">
                            Soma de todos os impostos a recolher no período
                        </p>
                    </div>

                    <div class="alert alert-success">
                        <strong>✅ Apuração Concluída!</strong> 
                        Todos os cálculos foram realizados automaticamente com base nos dados informados.
                        <br><br>
                        <strong>📋 Próximos Passos:</strong>
                        <br>• Gerar guias de recolhimento
                        <br>• Registrar nos livros fiscais
                        <br>• Efetuar pagamentos até dia 20
                    </div>
                </div>
            </div>

            <!-- Navigation -->
            <div class="navigation">
                <button class="btn btn-secondary" id="btnAnterior" onclick="voltarEtapa()" disabled>
                    ⬅️ Anterior
                </button>
                
                <div style="text-align: center;">
                    <button class="btn btn-warning" onclick="limparTudo()">🗑️ Limpar Tudo</button>
                    <button class="btn btn-success" onclick="gerarRelatorio()">📊 Gerar Relatório</button>
                </div>
                
                <button class="btn btn-primary" id="btnProximo" onclick="proximaEtapa()">
                    Próximo ➡️
                </button>
            </div>
        </div>
    </div>

    <script>
        // Variáveis globais
        let etapaAtual = 1;
        const totalEtapas = 4;

        // Alíquotas fixas (apenas PIS/COFINS que são federais)
        const aliquotas = {
            pis: {
                nao_cumulativo: 1.65,
                cumulativo: 0.65
            },
            cofins: {
                nao_cumulativo: 7.6,
                cumulativo: 3.0
            }
        };

        function validarAliquotaISS() {
            const aliquotaInput = document.getElementById('aliquotaISS');
            const valor = parseFloat(aliquotaInput.value);
            
            if (valor < 2) {
                aliquotaInput.value = 2;
                alert('⚠️ Alíquota mínima do ISS é 2,00%');
            } else if (valor > 5) {
                aliquotaInput.value = 5;
                alert('⚠️ Alíquota máxima do ISS é 5,00%');
            }
        }

        function validarAliquotaICMS() {
            const aliquotaInput = document.getElementById('aliquotaICMSInterna');
            const valor = parseFloat(aliquotaInput.value);
            
            if (valor < 7) {
                aliquotaInput.value = 7;
                alert('⚠️ Alíquota mínima do ICMS interno é 7,00%');
            } else if (valor > 25) {
                aliquotaInput.value = 25;
                alert('⚠️ Alíquota máxima do ICMS interno é 25,00%');
            }
        }

        function validarAliquotaICMSInter() {
            const aliquotaInput = document.getElementById('aliquotaICMSInter');
            const valor = parseFloat(aliquotaInput.value);
            
            if (valor < 4) {
                aliquotaInput.value = 4;
                alert('⚠️ Alíquota mínima do ICMS interestadual é 4,00%');
            } else if (valor > 12) {
                aliquotaInput.value = 12;
                alert('⚠️ Alíquota máxima do ICMS interestadual é 12,00%');
            }
        }

        function formatarMoeda(valor) {
            return new Intl.NumberFormat('pt-BR', {
                style: 'currency',
                currency: 'BRL'
            }).format(valor || 0);
        }

        function atualizarRegime() {
            const regime = document.getElementById('regime').value;
            const infoElement = document.getElementById('regimeInfo');
            
            let info = '';
            switch(regime) {
                case 'lucro_real':
                    info = 'Lucro Real - Permite créditos de PIS/COFINS não cumulativo (1,65% e 7,6%)';
                    break;
                case 'lucro_presumido':
                    info = 'Lucro Presumido - PIS/COFINS cumulativo (0,65% e 3,0%), sem direito a créditos';
                    break;
                case 'simples':
                    info = 'Simples Nacional - Tributação unificada com alíquotas reduzidas';
                    break;
            }
            
            infoElement.textContent = info;
            calcularAutomatico();
        }

        function atualizarAtividade() {
            calcularAutomatico();
        }

        function calcularAutomatico() {
            // Coletar valores das receitas
            const vendasInternas = parseFloat(document.getElementById('vendasInternas')?.value) || 0;
            const vendasInterestaduais = parseFloat(document.getElementById('vendasInterestaduais')?.value) || 0;
            const exportacoes = parseFloat(document.getElementById('exportacoes')?.value) || 0;
            const vendasIPI = parseFloat(document.getElementById('vendasIPI')?.value) || 0;
            const servicosMunicipio = parseFloat(document.getElementById('servicosMunicipio')?.value) || 0;
            const servicosOutros = parseFloat(document.getElementById('servicosOutros')?.value) || 0;
            const servicosExterior = parseFloat(document.getElementById('servicosExterior')?.value) || 0;
            const receitasFinanceiras = parseFloat(document.getElementById('receitasFinanceiras')?.value) || 0;
            const outrasReceitas = parseFloat(document.getElementById('outrasReceitas')?.value) || 0;

            // Calcular totais
            const totalProdutos = vendasInternas + vendasInterestaduais + exportacoes + vendasIPI;
            const totalServicos = servicosMunicipio + servicosOutros + servicosExterior;
            const faturamentoTotal = totalProdutos + totalServicos + receitasFinanceiras + outrasReceitas;
            const basePisCofins = totalProdutos + totalServicos; // Excluindo receitas financeiras

            // Atualizar displays
            if (document.getElementById('totalProdutos')) {
                document.getElementById('totalProdutos').textContent = formatarMoeda(totalProdutos);
            }
            if (document.getElementById('totalServicos')) {
                document.getElementById('totalServicos').textContent = formatarMoeda(totalServicos);
            }
            if (document.getElementById('faturamentoTotal')) {
                document.getElementById('faturamentoTotal').textContent = formatarMoeda(faturamentoTotal);
            }
            if (document.getElementById('basePisCofins')) {
                document.getElementById('basePisCofins').textContent = formatarMoeda(basePisCofins);
            }

            // Calcular impostos se estivermos na última etapa
            if (etapaAtual === 4) {
                calcularTodosImpostos();
            }
        }

        function calcularTodosImpostos() {
            const regime = document.getElementById('regime').value;
            
            // Coletar dados das receitas
            const vendasInternas = parseFloat(document.getElementById('vendasInternas')?.value) || 0;
            const vendasInterestaduais = parseFloat(document.getElementById('vendasInterestaduais')?.value) || 0;
            const vendasIPI = parseFloat(document.getElementById('vendasIPI')?.value) || 0;
            const servicosMunicipio = parseFloat(document.getElementById('servicosMunicipio')?.value) || 0;
            const servicosOutros = parseFloat(document.getElementById('servicosOutros')?.value) || 0;
            
            // Base para PIS/COFINS (todos os serviços + produtos, exceto financeiras)
            const basePisCofins = vendasInternas + vendasInterestaduais + vendasIPI + servicosMunicipio + servicosOutros;
            
            // Coletar dados dos custos
            const aquisicoesRevenda = parseFloat(document.getElementById('aquisicoesRevenda')?.value) || 0;
            const materiasPrimas = parseFloat(document.getElementById('materiasPrimas')?.value) || 0;
            const energiaEletrica = parseFloat(document.getElementById('energiaEletrica')?.value) || 0;
            const telecomunicacoes = parseFloat(document.getElementById('telecomunicacoes')?.value) || 0;
            const alugueis = parseFloat(document.getElementById('alugueis')?.value) || 0;
            const ativoImobilizado = parseFloat(document.getElementById('ativoImobilizado')?.value) || 0;
            
            const saldoICMS = parseFloat(document.getElementById('saldoICMS')?.value) || 0;
            const saldoIPI = parseFloat(document.getElementById('saldoIPI')?.value) || 0;
            const saldoPIS = parseFloat(document.getElementById('saldoPIS')?.value) || 0;
            const saldoCOFINS = parseFloat(document.getElementById('saldoCOFINS')?.value) || 0;
            
            const issRetido = parseFloat(document.getElementById('issRetido')?.value) || 0;
            const deducoesISS = parseFloat(document.getElementById('deducoesISS')?.value) || 0;

            let resultados = [];

            // ICMS
            if (vendasInternas > 0 || vendasInterestaduais > 0) {
                const aliquotaInterna = parseFloat(document.getElementById('aliquotaICMSInterna')?.value) || 18;
                const aliquotaInter = parseFloat(document.getElementById('aliquotaICMSInter')?.value) || 12;
                
                const icmsInternas = vendasInternas * (aliquotaInterna / 100);
                const icmsInterestaduais = vendasInterestaduais * (aliquotaInter / 100);
                const icmsDebito = icmsInternas + icmsInterestaduais;
                
                const icmsCredito = aquisicoesRevenda + materiasPrimas + energiaEletrica + telecomunicacoes + ativoImobilizado + saldoICMS;
                const icmsAPagar = icmsDebito - icmsCredito;
                
                resultados.push({
                    nome: 'ICMS',
                    valor: icmsAPagar,
                    detalhes: `Débito: ${formatarMoeda(icmsDebito)} (Interna: ${aliquotaInterna}%, Inter: ${aliquotaInter}%) | Crédito: ${formatarMoeda(icmsCredito)}`
                });
            }

            // IPI
            if (vendasIPI > 0) {
                const aliquotaIPI = parseFloat(document.getElementById('aliquotaIPI')?.value) || 10;
                const ipiDebito = vendasIPI * (aliquotaIPI / 100);
                
                // IPI sobre insumos (crédito presumido sobre matérias-primas) + saldo anterior
                const ipiCredito = (materiasPrimas * (aliquotaIPI / 100) * 0.1) + saldoIPI; // Estimativa de crédito
                const ipiAPagar = ipiDebito - ipiCredito;
                
                resultados.push({
                    nome: 'IPI',
                    valor: ipiAPagar,
                    detalhes: `Base: ${formatarMoeda(vendasIPI)} | Alíquota: ${aliquotaIPI}% | Crédito Total: ${formatarMoeda(ipiCredito)}`
                });
            }

            // ISS
            if (servicosMunicipio > 0 || servicosOutros > 0) {
                const aliquotaISS = parseFloat(document.getElementById('aliquotaISS')?.value) || 5;
                const baseISS = (servicosMunicipio + servicosOutros) - deducoesISS;
                const issDevido = baseISS * (aliquotaISS / 100);
                const issAPagar = Math.max(0, issDevido - issRetido);
                
                resultados.push({
                    nome: 'ISS',
                    valor: issAPagar,
                    detalhes: `Base: ${formatarMoeda(baseISS)} | Alíquota: ${aliquotaISS}% | Retido: ${formatarMoeda(issRetido)}`
                });
            }

            // PIS
            if (basePisCofins > 0 && regime !== 'simples') {
                const aliqPIS = regime === 'lucro_real' ? aliquotas.pis.nao_cumulativo : aliquotas.pis.cumulativo;
                const pisDebito = basePisCofins * (aliqPIS / 100);
                
                let pisCredito = saldoPIS;
                if (regime === 'lucro_real') {
                    pisCredito += (aquisicoesRevenda + materiasPrimas + energiaEletrica + alugueis + ativoImobilizado) * 0.0165;
                }
                
                const pisAPagar = pisDebito - pisCredito;
                
                resultados.push({
                    nome: 'PIS',
                    valor: pisAPagar,
                    detalhes: `Base: ${formatarMoeda(basePisCofins)} | Alíquota: ${aliqPIS}% | Crédito: ${formatarMoeda(pisCredito)}`
                });
            }

            // COFINS
            if (basePisCofins > 0 && regime !== 'simples') {
                const aliqCOFINS = regime === 'lucro_real' ? aliquotas.cofins.nao_cumulativo : aliquotas.cofins.cumulativo;
                const cofinsDebito = basePisCofins * (aliqCOFINS / 100);
                
                let cofinsCredito = saldoCOFINS;
                if (regime === 'lucro_real') {
                    cofinsCredito += (aquisicoesRevenda + materiasPrimas + energiaEletrica + alugueis + ativoImobilizado) * 0.076;
                }
                
                const cofinsAPagar = cofinsDebito - cofinsCredito;
                
                resultados.push({
                    nome: 'COFINS',
                    valor: cofinsAPagar,
                    detalhes: `Base: ${formatarMoeda(basePisCofins)} | Alíquota: ${aliqCOFINS}% | Crédito: ${formatarMoeda(cofinsCredito)}`
                });
            }

            exibirResultados(resultados);
        }

        function exibirResultados(resultados) {
            const container = document.getElementById('resultadosImpostos');
            let html = '';
            let totalAPagar = 0;

            resultados.forEach(resultado => {
                let classe, status, icon;
                
                if (resultado.valor > 0) {
                    classe = 'devedor';
                    status = 'devedor';
                    icon = '📤';
                    totalAPagar += resultado.valor;
                } else if (resultado.valor < 0) {
                    classe = 'credor';
                    status = 'credor';
                    icon = '📥';
                } else {
                    classe = 'neutro';
                    status = 'neutro';
                    icon = '⚖️';
                }

                const valorDisplay = Math.abs(resultado.valor);
                const statusText = resultado.valor > 0 ? 'A Recolher' : resultado.valor < 0 ? 'Saldo Credor' : 'Sem Movimento';

                html += `
                    <div class="imposto-card ${classe}">
                        <div class="imposto-header">
                            <div class="imposto-nome">${icon} ${resultado.nome} - ${statusText}</div>
                            <div class="imposto-valor ${status}">${formatarMoeda(valorDisplay)}</div>
                        </div>
                        <div class="calculo-detalhes">${resultado.detalhes}</div>
                    </div>
                `;
            });

            container.innerHTML = html;
            document.getElementById('totalRecolher').textContent = formatarMoeda(totalAPagar);
        }

        function proximaEtapa() {
            if (etapaAtual < totalEtapas) {
                // Marcar etapa atual como completa
                document.getElementById(`step${etapaAtual}`).className = 'step completed';
                
                // Ocultar seção atual
                document.getElementById(`secao${etapaAtual}`).classList.remove('active');
                
                // Avançar para próxima etapa
                etapaAtual++;
                
                // Mostrar nova seção
                document.getElementById(`secao${etapaAtual}`).classList.add('active');
                document.getElementById(`step${etapaAtual}`).className = 'step active';
                
                // Atualizar progresso
                const progress = (etapaAtual / totalEtapas) * 100;
                document.getElementById('progressFill').style.width = progress + '%';
                
                // Atualizar botões
                document.getElementById('btnAnterior').disabled = false;
                if (etapaAtual === totalEtapas) {
                    document.getElementById('btnProximo').textContent = '✅ Finalizar';
                    document.getElementById('btnProximo').onclick = finalizarApuracao;
                    calcularTodosImpostos();
                }

                if (etapaAtual === 2 || etapaAtual === 3) {
                    calcularAutomatico();
                }
            }
        }

        function voltarEtapa() {
            if (etapaAtual > 1) {
                // Marcar etapa atual como pendente
                document.getElementById(`step${etapaAtual}`).className = 'step pending';
                
                // Ocultar seção atual
                document.getElementById(`secao${etapaAtual}`).classList.remove('active');
                
                // Voltar para etapa anterior
                etapaAtual--;
                
                // Mostrar seção anterior
                document.getElementById(`secao${etapaAtual}`).classList.add('active');
                document.getElementById(`step${etapaAtual}`).className = 'step active';
                
                // Atualizar progresso
                const progress = (etapaAtual / totalEtapas) * 100;
                document.getElementById('progressFill').style.width = progress + '%';
                
                // Atualizar botões
                if (etapaAtual === 1) {
                    document.getElementById('btnAnterior').disabled = true;
                }
                
                document.getElementById('btnProximo').textContent = 'Próximo ➡️';
                document.getElementById('btnProximo').onclick = proximaEtapa;
            }
        }

        function finalizarApuracao() {
            alert('🎉 Apuração finalizada com sucesso!\n\n📊 Todos os impostos foram calculados automaticamente.\n💾 Dados salvos para geração de guias e relatórios.');
        }

        function limparTudo() {
            if (confirm('⚠️ Tem certeza que deseja limpar todos os dados?')) {
                document.querySelectorAll('input[type="number"]').forEach(input => input.value = '');
                etapaAtual = 1;
                
                // Reset das seções
                document.querySelectorAll('.section').forEach(secao => secao.classList.remove('active'));
                document.getElementById('secao1').classList.add('active');
                
                // Reset dos steps
                document.querySelectorAll('.step').forEach(step => step.className = 'step pending');
                document.getElementById('step1').className = 'step active';
                
                // Reset do progresso
                document.getElementById('progressFill').style.width = '25%';
                
                // Reset dos botões
                document.getElementById('btnAnterior').disabled = true;
                document.getElementById('btnProximo').textContent = 'Próximo ➡️';
                document.getElementById('btnProximo').onclick = proximaEtapa;
                
                calcularAutomatico();
            }
        }

        function gerarRelatorio() {
            alert('📊 Relatório Completo\n\n' +
                  '✅ Memória de cálculo detalhada\n' +
                  '✅ Guias de recolhimento pré-preenchidas\n' +
                  '✅ Demonstrativo de créditos utilizados\n' +
                  '✅ Livro de apuração automático\n' +
                  '✅ Análise de otimização tributária\n\n' +
                  '💾 Funcionalidade será implementada na versão completa.');
        }

        // Inicialização
        document.addEventListener('DOMContentLoaded', function() {
            atualizarRegime();
            calcularAutomatico();
        });
    </script>
</body>
</html>
